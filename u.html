<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TimberNova — Contact Your Arborist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{margin:0;background:#020617;color:#f9fafb;font-family:system-ui,sans-serif;display:flex;flex-direction:column;min-height:100vh;}
    main{padding:24px;max-width:500px;margin:0 auto;flex:1;}
    h1{font-size:24px;margin-bottom:4px;}
    .sub{color:#9ca3af;font-size:14px;margin-bottom:20px;}
    .panel{background:rgba(15,23,42,0.9);border-radius:16px;border:1px solid rgba(148,163,184,0.3);padding:20px;margin-bottom:20px;}
    .input{width:100%;border-radius:10px;border:1px solid rgba(148,163,184,0.6);background:rgba(15,23,42,0.9);color:#e5e7eb;padding:10px;font-size:14px;margin-bottom:10px;}
    .pill-btn{border-radius:999px;padding:10px 14px;font-size:14px;cursor:pointer;border:none;background:linear-gradient(120deg,#22c55e,#4ade80);color:#022c22;width:100%;}
    .profile-box{text-align:center;margin-bottom:20px;}
    .profile-pic{width:90px;height:90px;border-radius:999px;background:#1e293b;margin:0 auto 10px;border:2px solid rgba(148,163,184,0.4);}
    footer{text-align:center;padding:16px;color:#64748b;font-size:13px;}
  </style>
</head>
<body>

<main>
  <div class="profile-box">
    <div class="profile-pic" id="userPic"></div>
    <h1 id="userName">Your Arborist</h1>
    <div class="sub" id="userRole"></div>
  </div>

  <div class="panel">
    <h2 style="margin-top:0;font-size:18px;">Request a Quote</h2>
    <input id="clientName" class="input" placeholder="Your name" />
    <input id="clientPhone" class="input" placeholder="Phone number" />
    <input id="clientEmail" class="input" placeholder="Email" />
    <input id="clientAddress" class="input" placeholder="Job address" />
    <textarea id="clientNotes" class="input" placeholder="Describe the work" style="height:80px;"></textarea>
    <button class="pill-btn" id="submitBtn">Send Request</button>
  </div>

  <div id="statusMsg" style="text-align:center;color:#4ade80;font-size:14px;"></div>
</main>

<footer>TimberNova — Connecting crews & clients</footer>

<script>
/* ------------------------------
   LOAD USER PROFILE
------------------------------ */
function loadUsers(){
  try{return JSON.parse(localStorage.getItem("timberNovaUsers")||"[]");}
  catch{return[];}
}

const params=new URLSearchParams(location.search);
const uid=params.get("id");
const users=loadUsers();
const user=users.find(u=>u.id===uid);

if(!user){
  document.getElementById("userName").textContent="Arborist Not Found";
  document.getElementById("userRole").textContent="This link may be incorrect.";
} else {
  document.getElementById("userName").textContent=user.name;
  document.getElementById("userRole").textContent=user.role.charAt(0).toUpperCase()+user.role.slice(1);
}

/* ------------------------------
   SAVE CLIENT REQUEST
------------------------------ */
function loadClients(){
  try{return JSON.parse(localStorage.getItem("timberNovaClients")||"[]");}
  catch{return[];}
}
function saveClients(list){
  localStorage.setItem("timberNovaClients",JSON.stringify(list));
}
function id(){
  return Math.random().toString(36).slice(2)+Date.now().toString(36);
}

/* ------------------------------
   GEOCODE ADDRESS
------------------------------ */
async function geocode(address){
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
    const data=await res.json();
    if(data && data[0]) return {lat:parseFloat(data[0].lat),lng:parseFloat(data[0].lon)};
  }catch(e){}
  return {lat:null,lng:null};
}

/* ------------------------------
   SUBMIT REQUEST
------------------------------ */
document.getElementById("submitBtn").onclick=async()=>{
  const name=document.getElementById("clientName").value.trim();
  const phone=document.getElementById("clientPhone").value.trim();
  const email=document.getElementById("clientEmail").value.trim();
  const address=document.getElementById("clientAddress").value.trim();
  const notes=document.getElementById("clientNotes").value.trim();

  if(!name || !address){
    alert("Name and address required.");
    return;
  }

  const coords=await geocode(address);

  const clients=loadClients();
  clients.push({
    id:id(),
    name,phone,email,address,notes,
    lat:coords.lat,
    lng:coords.lng,
    referredBy:uid
  });
  saveClients(clients);

  document.getElementById("statusMsg").textContent="Request sent! Your arborist will contact you shortly.";

  document.getElementById("clientName").value="";
  document.getElementById("clientPhone").value="";
  document.getElementById("clientEmail").value="";
  document.getElementById("clientAddress").value="";
  document.getElementById("clientNotes").value="";
};
</script>

</body>
</html>
